name: Deploy Next.js to Server

on:
  push:
    branches:
      - rizkiG

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_FRONTEND }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_IP_FRONTEND }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          ssh ${{ secrets.SSH_USER_FRONTEND }}@${{ secrets.SSH_IP_FRONTEND }} << 'EOF'

            echo "Navigating to project directory..."
            cd ~/QuilvianSystemFrontendDevRizki

            echo "Resetting local changes..."
            sudo git reset --hard origin/rizkiG
            sudo git clean -fd

            echo "Pulling latest changes..."
            sudo git pull origin rizkiG

            IMAGE_NAME="quilvian-frontend-rizkiG"
            CONTAINER_NAME="quilvian-frontend-container-rizkiG"

            echo "Building new Docker image..."
            sudo docker build --build-arg NEXT_PUBLIC_API_QUILVIAN=http://160.20.104.98/api -t $IMAGE_NAME .

            echo "Stopping and removing old container..."
            sudo docker stop $CONTAINER_NAME || true
            sudo docker rm $CONTAINER_NAME || true

            echo "Running new container with correct port..."
            sudo docker run -d --name $CONTAINER_NAME -p 80:3710 --env-file .env $IMAGE_NAME

            echo "Cleaning up unused Docker images..."
            sudo docker system prune -af

            echo "Deployment completed!"

            # Kirim notifikasi ke Telegram
            curl -X POST "https://api.telegram.org/bot7630899059:AAFqAUGUB7I5V9VGKXbcmoWmbYWvrdmnje8/sendMessage" \
                -d chat_id=-1002437306112 \
                -d text="âœ… Deployment Sukses! ðŸš€
                *Docker Image:* $IMAGE_NAME
                *Container:* $CONTAINER_NAME
                *Tanggal:* $(date +'%Y-%m-%d %H:%M:%S')
                Deployment dilakukan Frontend *rizkiG*
                ðŸ”„ Container telah diperbarui. ðŸŽ‰"
          EOF

# name: Deploy Next.js to Server

# on:
#   push:
#     branches:
#       - QuilvianDev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout Repository
#       uses: actions/checkout@v4

#     - name: Setup SSH Connection
#       run: |
#         mkdir -p ~/.ssh
#         echo "${{ secrets.SSH_PRIVATE_KEY_FRONTEND }}" > ~/.ssh/id_rsa
#         chmod 600 ~/.ssh/id_rsa
#         ssh-keyscan -H ${{ secrets.SSH_IP_FRONTEND }} >> ~/.ssh/known_hosts

#     - name: Deploy to Server
#       run: |
#         ssh ${{ secrets.SSH_USER_FRONTEND }}@${{ secrets.SSH_IP_FRONTEND }} << 'EOF'

#           echo "Navigating to project directory..."
#           cd ~/QuilvianSystemFrontendDev

#           echo "Resetting local changes..."
#           sudo git reset --hard origin/QuilvianDev
#           sudo git clean -fd

#           echo "Pulling latest changes..."
#           sudo git pull origin QuilvianDev

#           IMAGE_NAME="quilvian-frontend-quilviandev"
#           CONTAINER_NAME="quilvian-frontend-container"

#           echo "Building new Docker image..."
#           sudo docker build --build-arg NEXT_PUBLIC_API_QUILVIAN=http://160.20.104.98/api -t $IMAGE_NAME .

#           echo "Stopping and removing old container..."
#           sudo docker stop $CONTAINER_NAME || true
#           sudo docker rm $CONTAINER_NAME || true

#           echo "Running new container with environment variables..."
#           sudo docker run -d --name $CONTAINER_NAME -p 8080:3000 --env-file .env $IMAGE_NAME

#           echo "Cleaning up unused Docker images..."
#           sudo docker system prune -af

#           echo "Deployment completed!"

#           # Kirim notifikasi ke Telegram
#           curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
#               -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
#               -d text="âœ… Deployment Sukses! ðŸš€%0A
#               ðŸ”¹ *Docker Image:* $IMAGE_NAME%0A
#               ðŸ”¹ *Container:* $CONTAINER_NAME%0A
#               ðŸ“… *Tanggal:* $(date +'%Y-%m-%d %H:%M:%S')%0A
#               ðŸ›  Deployment dilakukan oleh Branch Frontend *QuilvianDev*%0A
#               ðŸ”„ Container telah diperbarui dan berjalan dengan baik. ðŸŽ‰"
#         EOF

# # name: Deploy Next.js to Server

# # on:
# #   push:
# #     branches:
# #       - QuilvianDev

# # jobs:
# #   deploy:
# #     runs-on: ubuntu-latest

# #     steps:
# #     - name: Checkout Repository
# #       uses: actions/checkout@v4

# #     - name: Setup SSH Connection
# #       run: |
# #         mkdir -p ~/.ssh
# #         echo "${{ secrets.SSH_PRIVATE_KEY_FRONTEND }}" > ~/.ssh/id_rsa
# #         chmod 600 ~/.ssh/id_rsa
# #         ssh-keyscan -H ${{ secrets.SSH_IP_FRONTEND }} >> ~/.ssh/known_hosts

# #     - name: Deploy to Server
# #       run: |
# #         ssh ${{ secrets.SSH_USER_FRONTEND }}@${{ secrets.SSH_IP_FRONTEND }} << 'EOF'

# #           echo "Navigating to project directory..."
# #           cd ~/QuilvianSystemFrontendDev

# #           echo "Resetting local changes..."
# #           sudo git reset --hard origin/QuilvianDev
# #           sudo git clean -fd

# #           echo "Pulling latest changes..."
# #           sudo git pull origin QuilvianDev

# #           IMAGE_NAME="quilvian-frontend-quilviandev"
# #           CONTAINER_NAME="quilvian-frontend-container"

# #           echo "Building new Docker image..."
# #           sudo docker build -t $IMAGE_NAME .

# #           echo "Stopping and removing old container..."
# #           sudo docker stop $CONTAINER_NAME || true
# #           sudo docker rm $CONTAINER_NAME || true

# #           echo "Running new container..."
# #           sudo docker run -d --name $CONTAINER_NAME -p 8080:3000 $IMAGE_NAME

# #           echo "Cleaning up unused Docker images..."
# #           sudo docker system prune -af

# #           echo "Deployment completed!"
# #           curl -X POST https://api.telegram.org/bot7630899057:AAFqAUGUB7I5V9VGKXbcmoWmbYWvrdmnje8/sendMessage \
# #               -d chat_id=-1002437306112 \
# #               -d text="âœ… Deployment Sukses! ðŸš€%0A
# #               ðŸ”¹ *Docker Image:* $IMAGE_NAME%0A
# #               ðŸ”¹ *Container:* $CONTAINER_NAME%0A
# #               ðŸ“… *Tanggal:* $DEPLOY_TIME%0A
# #               ðŸ› ï¸ Deployment dilakukan oleh Branch Frontend *QuilvianDev*%0A
# #               ðŸ”„ Container telah diperbarui dan berjalan dengan baik. ðŸŽ‰"
# #         EOF
