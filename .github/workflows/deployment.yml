name: Deploy Next.js to Server

on:
  push:
    branches:
      - QuilvianDev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup SSH Connection
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY_FRONTEND }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_IP_FRONTEND }} >> ~/.ssh/known_hosts

    - name: Deploy to Server
      run: |
        ssh ${{ secrets.SSH_USER_FRONTEND }}@${{ secrets.SSH_IP_FRONTEND }} << 'EOF'

          echo "Navigating to project directory..."
          cd ~/QuilvianSystemFrontendDev

          echo "Resetting local changes..."
          sudo git reset --hard origin/QuilvianDev
          sudo git clean -fd

          echo "Pulling latest changes..."
          sudo git pull origin QuilvianDev

          IMAGE_NAME="quilvian-frontend-quilviandev"
          CONTAINER_NAME="quilvian-frontend-container"

          echo "Building new Docker image..."
          sudo docker build -t $IMAGE_NAME .

          echo "Stopping and removing old container..."
          sudo docker stop $CONTAINER_NAME || true
          sudo docker rm $CONTAINER_NAME || true

          echo "Running new container..."
          sudo docker run -d --name $CONTAINER_NAME -p 80:3000 $IMAGE_NAME

          echo "Cleaning up unused Docker images..."
          sudo docker system prune -af

          echo "Deployment completed!"
        EOF
